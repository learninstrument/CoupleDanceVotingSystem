<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar { min-height: 100vh; background-color: #212529; color: white; }
        .sidebar a { color: #adb5bd; text-decoration: none; padding: 10px 15px; display: block; }
        .sidebar a:hover, .sidebar a.active { background-color: #343a40; color: white; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Left Navbar (Sidebar) -->
            <nav class="col-md-2 d-none d-md-block sidebar p-0">
                <div class="p-3 text-center border-bottom border-secondary">
                    <h4>Admin Panel</h4>
                    <small>Welcome, <%= user.username %></small>
                </div>
                <div class="mt-3">
                    <a href="#" class="active">üìä Dashboard Overview</a>
                    <a href="#users-section">üë• Users & Payments</a>
                    <a href="#votes-section">üó≥Ô∏è Voting Logs</a>
                    <a href="#settings-section">‚öôÔ∏è Settings</a>
                    <a href="#referrals-section">üîó Referral Network</a>
                    <a href="#transactions-section">üí≥ Transactions Log</a>
                    <a href="/" target="_blank">üè† View Homepage</a>
                    <a href="/logout" class="text-danger mt-5">üö™ Logout</a>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-10 ms-sm-auto px-md-4 py-4">
                <!-- Stats Cards -->
                <div class="row mb-4 g-3">
                    <div class="col-md-4 col-lg-2">
                        <div class="card bg-primary text-white shadow-sm h-100">
                            <div class="card-body p-3">
                                <h6 class="card-title small text-uppercase">Total Users</h6>
                                <h3 class="mb-0"><%= stats.total_users %></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2">
                        <div class="card bg-info text-white shadow-sm h-100">
                            <div class="card-body p-3">
                                <h6 class="card-title small text-uppercase">Paid Regs</h6>
                                <h3 class="mb-0"><%= stats.total_registrations %></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2">
                        <div class="card bg-success text-white shadow-sm h-100">
                            <div class="card-body p-3">
                                <h6 class="card-title small text-uppercase">Reg Revenue</h6>
                                <h3 class="mb-0">‚Ç¶<%= stats.total_registration_revenue.toLocaleString() %></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2">
                        <div class="card bg-warning text-dark shadow-sm h-100">
                            <div class="card-body p-3">
                                <h6 class="card-title small text-uppercase">Contestants</h6>
                                <h3 class="mb-0"><%= stats.total_contestants %></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2">
                        <div class="card bg-secondary text-white shadow-sm h-100">
                            <div class="card-body p-3">
                                <h6 class="card-title small text-uppercase">Total Votes</h6>
                                <h3 class="mb-0"><%= stats.total_votes.toLocaleString() %></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2">
                        <div class="card bg-success text-white shadow-sm h-100">
                            <div class="card-body p-3">
                                <h6 class="card-title small text-uppercase">Vote Revenue</h6>
                                <h3 class="mb-0">‚Ç¶<%= stats.total_vote_revenue.toLocaleString() %></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg-2">
                        <div class="card bg-dark text-white shadow-sm h-100">
                            <div class="card-body p-3">
                                <h6 class="card-title small text-uppercase">Total Revenue</h6>
                                <h3 class="mb-0">‚Ç¶<%= stats.total_revenue.toLocaleString() %></h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Leaderboard Highlights -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-info text-white shadow-sm">
                            <div class="card-body">
                                <h5>üèÜ Leading Contestant</h5>
                                <% if(topContestant) { %>
                                    <h3><%= topContestant.username %></h3>
                                    <p class="mb-0"><%= topContestant.total_votes %> Total Votes</p>
                                <% } else { %>
                                    <p>No votes yet.</p>
                                <% } %>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-secondary text-white shadow-sm">
                            <div class="card-body">
                                <h5>ü•á Top Supporter (for Leader)</h5>
                                <% if(topVoter) { %>
                                    <h3><%= topVoter.username %></h3>
                                    <p class="mb-0">Contributed <%= topVoter.votes_given %> votes</p>
                                <% } else { %>
                                    <p>No data available.</p>
                                <% } %>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-danger text-white shadow-sm">
                            <div class="card-body">
                                <h5>üìâ Lowest Voted</h5>
                                <% if(lowestContestant) { %>
                                    <h3><%= lowestContestant.username %></h3>
                                    <p class="mb-0"><%= lowestContestant.total_votes %> Total Votes</p>
                                <% } else { %>
                                    <p>No data available.</p>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">üìà Voting Trends (Daily)</h5>
                        <canvas id="votesChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="card shadow-sm mb-4" id="settings-section">
                    <div class="card-body">
                        <h5 class="card-title mb-3">‚öôÔ∏è Competition Settings</h5>
                        <form action="/admin/update-settings" method="POST" class="row align-items-end">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Registration Fee (‚Ç¶)</label>
                                <input type="number" name="registration_fee" class="form-control" value="<%= registrationFee %>" required>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100">Update Fee</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Users Table -->
                <h3 id="users-section" class="mt-5 border-bottom pb-2 text-success">‚úÖ Paid Users / Contestants</h3>
                <div class="table-responsive bg-white shadow-sm p-3 rounded">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Photo</th>
                                <th>Video</th>
                                <th>S/N</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Social Media</th>
                                <th>Referral Code</th>
                                <th>Paystack Ref</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% users.filter(u => u.has_paid).forEach((u, index) => { %>
                                <tr>
                                    <td>
                                        <% if(u.profile_pic) { %>
                                            <img src="/uploads/<%= u.profile_pic %>" alt="img" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                                        <% } else { %>
                                            <span class="badge bg-secondary">No Pic</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if(u.video_filename) { %>
                                            <video width="120" height="80" controls preload="metadata" class="border rounded">
                                                <source src="/uploads/<%= u.video_filename %>" type="video/mp4">
                                            </video>
                                        <% } else { %>
                                            <span class="text-muted small">No Video</span>
                                        <% } %>
                                    </td>
                                    <td><%= index + 1 %></td>
                                    <td><%= u.username %></td>
                                    <td><%= u.email %></td>
                                    <td><%= u.phone_number %></td>
                                    <td><%= u.social_media_handle %></td>
                                    <td><code><%= u.referral_code %></code></td>
                                    <td><small class="text-muted"><%= u.payment_reference || 'N/A' %></small></td>
                                    <td><span class="badge bg-success">Paid</span></td>
                                    <td>
                                        <div class="d-flex gap-2">
                                            <% if(u.contestant_id) { %>
                                                <button type="button" class="btn btn-info btn-sm text-white" onclick="viewVoters(<%= u.contestant_id %>, '<%= u.username %>')">View Voters</button>
                                            <% } %>
                                            <% if(u.video_filename) { %>
                                                <form action="/admin/delete-video" method="POST" onsubmit="return confirm('Are you sure you want to delete this video?');">
                                                    <input type="hidden" name="user_id" value="<%= u.id %>">
                                                    <button type="submit" class="btn btn-warning btn-sm">Del Video</button>
                                                </form>
                                            <% } %>
                                            <form action="/admin/delete-user" method="POST" onsubmit="return confirm('Are you sure you want to delete this user? This cannot be undone.');">
                                                <input type="hidden" name="user_id" value="<%= u.id %>">
                                                <button type="submit" class="btn btn-danger btn-sm">Del User</button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>

                <h3 class="mt-5 border-bottom pb-2 text-danger">‚ùå Unpaid Users</h3>
                <div class="table-responsive bg-white shadow-sm p-3 rounded">
                    <table class="table table-striped table-hover">
                        <thead class="table-secondary">
                            <tr>
                                <th>Photo</th>
                                <th>S/N</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Social Media</th>
                                <th>Referral Code</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% users.filter(u => !u.has_paid).forEach((u, index) => { %>
                                <tr>
                                    <td>
                                        <% if(u.profile_pic) { %>
                                            <img src="/uploads/<%= u.profile_pic %>" alt="img" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                                        <% } else { %>
                                            <span class="badge bg-secondary">No Pic</span>
                                        <% } %>
                                    </td>
                                    <td><%= index + 1 %></td>
                                    <td><%= u.username %></td>
                                    <td><%= u.email %></td>
                                    <td><%= u.phone_number %></td>
                                    <td><%= u.social_media_handle %></td>
                                    <td><code><%= u.referral_code %></code></td>
                                    <td><span class="badge bg-danger">Not Paid</span></td>
                                    <td>
                                        <form action="/admin/delete-user" method="POST" onsubmit="return confirm('Are you sure you want to delete this user?');">
                                            <input type="hidden" name="user_id" value="<%= u.id %>">
                                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>

                <!-- Referrals Section -->
                <h3 id="referrals-section" class="mt-5 border-bottom pb-2 text-primary">üîó Referral Network</h3>
                <div class="accordion shadow-sm mb-5" id="referralAccordion">
                    <% if(referrals.length === 0) { %>
                        <div class="p-3 bg-white">No referrals found.</div>
                    <% } %>
                    <% referrals.forEach((ref, index) => { %>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading<%= index %>">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>">
                                    <div class="d-flex justify-content-between w-100 me-3">
                                        <span><strong><%= ref.name %></strong> (<%= ref.email %>)</span>
                                        <span class="badge bg-primary rounded-pill"><%= ref.referees.length %> Referrals</span>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse<%= index %>" class="accordion-collapse collapse" data-bs-parent="#referralAccordion">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Referee Name</th>
                                                    <th>Email</th>
                                                    <th>Phone</th>
                                                    <th>Social</th>
                                                    <th>Status</th>
                                                    <th>Joined</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% ref.referees.forEach(r => { %>
                                                    <tr>
                                                        <td><%= r.name %></td>
                                                        <td><%= r.email %></td>
                                                        <td><%= r.phone %></td>
                                                        <td><%= r.social %></td>
                                                        <td>
                                                            <% if(r.paid) { %>
                                                                <span class="badge bg-success">Paid</span>
                                                            <% } else { %>
                                                                <span class="badge bg-secondary">Free</span>
                                                            <% } %>
                                                        </td>
                                                        <td><%= new Date(r.joined).toLocaleDateString() %></td>
                                                    </tr>
                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>

                <!-- Votes Table -->
                <h3 id="votes-section" class="mt-5 border-bottom pb-2">Voting Activity</h3>
                <div class="table-responsive bg-white shadow-sm p-3 rounded">
                    <table class="table table-bordered">
                        <thead class="table-secondary">
                            <tr>
                                <th>Date</th>
                                <th>Voter Name</th>
                                <th>Voted For (Contestant)</th>
                                <th>Votes Cast</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% votes.forEach(v => { %>
                                <tr>
                                    <td><%= new Date(v.created_at).toLocaleString() %></td>
                                    <td><%= v.voter_name %></td>
                                    <td><strong><%= v.contestant_name %></strong></td>
                                    <td><%= v.number_of_votes %></td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>

                <!-- Transactions Log Section -->
                <h3 id="transactions-section" class="mt-5 border-bottom pb-2 text-info">üí≥ Transactions Log</h3>
                <form action="/admin" method="GET" class="row g-2 mb-3 align-items-center">
                    <div class="col-auto">
                        <input type="text" name="trans_search" class="form-control form-control-sm" placeholder="Search Ref or Email" value="<%= typeof transSearch !== 'undefined' ? transSearch : '' %>">
                    </div>
                    <div class="col-auto">
                        <select name="trans_status" class="form-select form-select-sm">
                            <option value="">All Status</option>
                            <option value="success" <%= typeof transStatus !== 'undefined' && transStatus === 'success' ? 'selected' : '' %>>Success</option>
                            <option value="pending" <%= typeof transStatus !== 'undefined' && transStatus === 'pending' ? 'selected' : '' %>>Pending</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-sm btn-primary">Filter</button>
                        <a href="/admin" class="btn btn-sm btn-secondary">Reset</a>
                    </div>
                </form>
                <div class="table-responsive bg-white shadow-sm p-3 rounded">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>S/N</th>
                                <th>Reference</th>
                                <th>User</th>
                                <th>Amount</th>
                                <th>Purpose</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% transactions.forEach((t, index) => { %>
                                <tr>
                                    <td><%= index + 1 %></td>
                                    <td><code><%= t.reference %></code></td>
                                    <td><%= t.username %> (<%= t.email %>)</td>
                                    <td>‚Ç¶<%= t.amount.toLocaleString() %></td>
                                    <td><%= t.purpose %></td>
                                    <td>
                                        <% if(t.status === 'success') { %>
                                            <span class="badge bg-success">Success</span>
                                        <% } else { %>
                                            <span class="badge bg-warning text-dark">Pending</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <form action="/admin/delete-transaction" method="POST" onsubmit="return confirm('Are you sure you want to delete this transaction log?');">
                                            <input type="hidden" name="transaction_id" value="<%= t.id %>">
                                            <button type="submit" class="btn btn-danger btn-sm py-0" style="font-size: 0.8rem;">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <!-- Voters Details Modal -->
    <div class="modal fade" id="votersModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Voters for <span id="modalContestantName" class="fw-bold"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Voter Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Votes Given</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="modalVotersBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <p id="noVotersMsg" class="text-center text-muted d-none">No voters found for this contestant.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const ctx = document.getElementById('votesChart').getContext('2d');
        const chartData = <%- JSON.stringify(chartData) %>;
        const allVotes = <%- JSON.stringify(votes) %>;
        
        const labels = chartData.map(d => d.date);
        const data = chartData.map(d => d.count);

        // Function to open modal and show voters
        function viewVoters(contestantId, contestantName) {
            const modal = new bootstrap.Modal(document.getElementById('votersModal'));
            document.getElementById('modalContestantName').innerText = contestantName;
            
            const tbody = document.getElementById('modalVotersBody');
            tbody.innerHTML = '';
            
            const contestantVotes = allVotes.filter(v => v.contestant_id === contestantId);
            
            if (contestantVotes.length === 0) {
                document.getElementById('noVotersMsg').classList.remove('d-none');
            } else {
                document.getElementById('noVotersMsg').classList.add('d-none');
                contestantVotes.forEach(v => {
                    const row = `
                        <tr>
                            <td>${v.voter_name}</td>
                            <td>${v.voter_email}</td>
                            <td>${v.voter_phone}</td>
                            <td>${v.number_of_votes}</td>
                            <td>${new Date(v.created_at).toLocaleDateString()}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
            
            modal.show();
        }

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Votes',
                    data: data,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    </script>
</body>
</html>